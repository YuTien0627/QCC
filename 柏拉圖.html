<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可愛純淨版柏拉圖</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #FFFBF0; /* 溫暖底色 */
            font-family: 'Noto Sans TC', sans-serif;
        }
        .chart-wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            box-sizing: border-box;
        }
        .chart-container {
            width: 100%;
            height: 100%;
            background: #FFFFFF;
            border-radius: 40px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(255, 182, 193, 0.4);
            border: 6px solid #FFE4E1;
            box-sizing: border-box;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>

    <div class="chart-wrapper">
        <div class="chart-container" id="chart-container-div">
            <!-- Canvas will be rendered here -->
        </div>
    </div>

    <script>
        window.onload = function() {
            window.renderPareto('chart-container-div');
        };

        window.renderPareto = function (containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <canvas id="pareto-canvas"></canvas>
            `;

            const ctx = document.getElementById('pareto-canvas').getContext('2d');

            const rawData = [
                { reason: '表面刮痕', count: 185 },
                { reason: '尺寸誤差', count: 90 },
                { reason: '組裝間隙', count: 65 },
                { reason: '標籤脫落', count: 35 },
                { reason: '顏色不均', count: 20 },
                { reason: '其他項目', count: 15 }
            ];

            // 排序數據
            rawData.sort((a, b) => b.count - a.count);
            const totalCount = rawData.reduce((sum, item) => sum + item.count, 0);
            
            // 設定參數：長條佔 80% 寬度，保留 20% 間隔
            const barWidthRatio = 0.8; 
            const labels = rawData.map(d => d.reason);
            
            let runningSum = 0;
            const lineData = [{x: 0, y: 0}]; // (0,0) 起點
            const barData = [];
            let eightyPercentPoint = null;

            rawData.forEach((item, index) => {
                runningSum += item.count;
                // 讓點位於長條中心：index + 0.4 (如果寬度 0.8)
                const centerPoint = index + (barWidthRatio / 2);
                const percentage = ((runningSum / totalCount) * 100).toFixed(1);
                
                lineData.push({
                    x: centerPoint,
                    y: percentage
                });
                
                barData.push({
                    x: centerPoint,
                    y: item.count
                });

                // 抓取 80% 關鍵點 (通常是組裝間隙)
                if (percentage >= 80 && eightyPercentPoint === null) {
                    eightyPercentPoint = {
                        x: centerPoint,
                        y: percentage,
                        count: runningSum
                    };
                }
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [
                        {
                            label: '累積百分比 (%)',
                            data: lineData,
                            type: 'line',
                            borderColor: '#FF7EB9', // 可愛粉紅
                            backgroundColor: '#FF7EB9',
                            borderWidth: 5,
                            pointRadius: 7,
                            pointHoverRadius: 10,
                            pointBackgroundColor: '#FFFFFF',
                            pointBorderColor: '#FF7EB9',
                            pointBorderWidth: 3,
                            yAxisID: 'yPercentage',
                            tension: 0,
                            order: 1
                        },
                        {
                            label: '發生次數',
                            data: barData,
                            type: 'bar',
                            // 馬卡龍配色
                            backgroundColor: ['#A2D2FF', '#BDE0FE', '#FFC8DD', '#FFAFCC', '#FFB7B2', '#FFDAC1'],
                            borderRadius: 15, // 圓角長條
                            yAxisID: 'yCount',
                            order: 2,
                            barPercentage: barWidthRatio,
                            categoryPercentage: 1.0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0,
                            max: rawData.length,
                            grid: { display: false },
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    const labelIndex = Math.floor(value);
                                    if (Math.abs(value - (labelIndex + (barWidthRatio / 2))) < 0.01) {
                                        return labels[labelIndex] || '';
                                    }
                                    return '';
                                },
                                font: { size: 14, weight: 'bold' },
                                color: '#666'
                            }
                        },
                        yCount: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            max: totalCount,
                            title: {
                                display: true,
                                text: '次數',
                                font: { size: 14, weight: 'bold' },
                                color: '#4A4A4A'
                            },
                            grid: { color: '#FFE4E1' }
                        },
                        yPercentage: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '累積百分比 (%)',
                                font: { size: 14, weight: 'bold' },
                                color: '#FF7EB9'
                            },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { weight: 'bold', size: 14 } }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#FF7EB9',
                            bodyColor: '#4A4A4A',
                            borderColor: '#FF7EB9',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 10,
                            callbacks: {
                                title: (context) => labels[Math.floor(context[0].parsed.x)] || '',
                                label: (context) => context.datasetIndex === 0 ? ` 累積：${context.parsed.y}%` : ` 次數：${context.parsed.y}`
                            }
                        },
                        annotation: {
                            annotations: {
                                hLine: {
                                    type: 'line',
                                    yMin: eightyPercentPoint.count,
                                    yMax: eightyPercentPoint.count,
                                    xMin: 0,
                                    xMax: eightyPercentPoint.x,
                                    borderColor: 'rgba(255, 126, 185, 0.8)',
                                    borderWidth: 3,
                                    borderDash: [6, 6],
                                    yAxisID: 'yCount'
                                },
                                vLine: {
                                    type: 'line',
                                    xMin: eightyPercentPoint.x,
                                    xMax: eightyPercentPoint.x,
                                    yMin: 0,
                                    yMax: eightyPercentPoint.count,
                                    borderColor: 'rgba(255, 126, 185, 0.8)',
                                    borderWidth: 3,
                                    borderDash: [6, 6],
                                    yAxisID: 'yCount'
                                },
                                pointLabel: {
                                    type: 'label',
                                    xValue: eightyPercentPoint.x,
                                    yValue: eightyPercentPoint.count,
                                    backgroundColor: '#FF7EB9',
                                    content: ['80% 關鍵'],
                                    font: { size: 12, weight: 'bold' },
                                    color: '#fff',
                                    borderRadius: 50,
                                    padding: 8,
                                    position: 'center',
                                    yAdjust: -30,
                                    yAxisID: 'yCount'
                                }
                            }
                        }
                    }
                }
            });

            console.log('✅ renderPareto 已成功掛載並執行');
        };
    </script>
</body>
</html>
