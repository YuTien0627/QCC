<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QCC çŸ¥è­˜æŒ‘æˆ°</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
<style>
body { font-family:'Noto Sans TC',sans-serif; background-color:#ecfdf5; margin:0; overflow:hidden; }
.quiz-card { background-color:#ffffff; border-radius:1.5rem; box-shadow:0 20px 35px -18px rgba(15,23,42,0.45); display:flex; flex-direction:column; height:100vh; padding:1.5rem; }
.quiz-type-btn { color:white; padding:1.5rem; border-radius:1rem; font-weight:700; font-size:1.5rem; transition: transform 0.2s, box-shadow 0.2s; border:2px solid white; flex-grow:1; }
.quiz-type-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow:0 10px 25px rgba(0,0,0,0.2); }
.answer-option { transition: all 0.3s; cursor:pointer; border-width:2px; background:white; padding:1.5rem; border-radius:1rem; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:0.75rem; }
.answer-option:hover:not(.disabled) { transform: translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,0.15); }
.correct-blink { animation: correctBlink 0.5s ease-in-out 3; pointer-events:none; }
@keyframes correctBlink { 0%,100% {background-color:#6ee7b7;border-color:#059669; transform: scale(1.05);} 50% {background-color:#d1fae5;border-color:#10b981; transform: scale(1);} }
.incorrect-shake { animation: incorrectShake 0.4s ease-in-out; pointer-events:none; filter:grayscale(80%);}
@keyframes incorrectShake { 0%,100%{transform:translateX(0);background-color:#fca5a5;border-color:#dc2626;} 20%,60%{transform:translateX(-6px);} 40%,80%{transform:translateX(6px);} }
.fun-action-btn { background-image: linear-gradient(to right,#06b6d4,#0d9488); color:white; transition: all 0.2s; padding:1.5rem; border-radius:1rem; font-size:1.5rem; font-weight:700; }
.fun-action-btn:hover:not(:disabled) { transform: scale(1.02); box-shadow:0 8px 20px rgba(0,0,0,0.3); }
.fun-action-btn:disabled { background:#9ca3af; cursor:not-allowed; }
#quizFeedback { font-size:1.5rem; line-height:1.4; }
#bodySection { flex-grow:1; overflow-y:auto; padding-top:1rem; }
</style>
</head>
<body>

<div id="app" class="quiz-card">
    <!-- é ­éƒ¨å€å¡Š -->
    <header id="headerSection" class="mb-4">
        <h1 id="mainTitle" class="text-4xl font-extrabold text-teal-700 text-center mb-4">
            ğŸ› ï¸ QCC çŸ¥è­˜å°æ¸¬é©— ğŸ¯
        </h1>
        <div class="max-w-2xl mx-auto text-center px-4">
            <p class="text-lg text-teal-900/70 font-medium mb-2">
                æŒæ¡å“ç®¡å·¥å…·ç†Ÿç·´åº¦ï¼Œé–‹å•Ÿæ‚¨çš„å°ˆæ¥­é€²åŒ–ä¹‹è·¯
            </p>
            <p class="text-gray-500 text-sm leading-relaxed">
                æœ¬æ¸¬é©—æ—¨åœ¨è©•ä¼°æ‚¨å°å“ç®¡å·¥å…·çš„ç­è§£ç¨‹åº¦ï¼Œå®Œæˆå¾Œå°‡æä¾›å®Œæ•´çš„ã€Œè½é»åˆ†æå ±å‘Šã€ï¼Œ
                ä¸¦æ ¹æ“šåˆ†æå»ºè­°ï¼Œå¼•å°æ‚¨é¸æ“‡æœ€é©åˆçš„èª²ç¨‹ã€‚
            </p>
        </div>
        <div id="welcomeScreen" class="p-6 rounded-xl shadow-md text-center">
            <h2 class="text-3xl font-bold mb-4">ğŸ† è«‹é¸æ“‡æŒ‘æˆ°é¡å‹ ğŸ†</h2>
            <div id="typeSelector" class="flex flex-col md:flex-row gap-4">
                <button id="selectProblemType" data-type="problem" class="quiz-type-btn bg-teal-500 hover:bg-teal-600">å•é¡Œè§£æ±ºå‹</button>
                <button id="selectSolutionType" data-type="solution" class="quiz-type-btn bg-indigo-500 hover:bg-indigo-600">èª²é¡Œé”æˆå‹</button>
            </div>
        </div>
    </header>

    <!-- èº«é«”å€å¡Š -->
    <main id="bodySection" class="flex flex-col gap-4">
        <div id="progressSection" class="mb-4 hidden">
            <div id="progressDisplay" class="text-lg font-bold text-teal-700 mb-2 text-center">æº–å‚™é–‹å§‹...</div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gradient-to-r from-teal-400 to-indigo-500 h-3 rounded-full transition-all duration-500" style="width:0%"></div>
            </div>
        </div>

        <div id="quizContainer" class="hidden p-6 rounded-xl shadow-md border-2 border-teal-300">
            <p id="quizQuestion" class="text-2xl font-extrabold text-gray-800 text-center mb-6">é¡Œç›®å…§å®¹</p>
            <div id="quizOptions"></div>
            <div id="quizFeedback" class="hidden mt-4 p-4 text-center rounded-xl font-bold border-2"></div>
            <button id="mainActionBtn" class="fun-action-btn w-full mt-6">é€²è¡Œä¸‹ä¸€é¡Œ</button>
        </div>

        <div id="resultContainer" class="hidden mt-6 p-6 rounded-xl shadow-md border-2 border-teal-400"></div>
    </main>
</div>

<script type="module">
import { PROBLEM_STEPS_DATA, SOLUTION_STEPS_DATA } from './quizData.js';

// ===== å…¨åŸŸç‹€æ…‹ =====
let currentQuestions = [];
let currentQuestionIndex = -1;
let userScore = 0;
let quizInProgress = false;
let stepPerformance = {};
let selectedQuizType = 'problem';
let domRefs = {};

// ===== åˆå§‹åŒ– =====
function initializeQuiz() {
    domRefs = {
        mainTitle: document.getElementById('mainTitle'),
        welcomeScreen: document.getElementById('welcomeScreen'),
        progressSection: document.getElementById('progressSection'),
        quizContainer: document.getElementById('quizContainer'),
        quizQuestion: document.getElementById('quizQuestion'),
        quizOptions: document.getElementById('quizOptions'),
        quizFeedback: document.getElementById('quizFeedback'),
        mainActionBtn: document.getElementById('mainActionBtn'),
        progressDisplay: document.getElementById('progressDisplay'),
        progressBar: document.getElementById('progressBar'),
        resultContainer: document.getElementById('resultContainer')
    };

    currentQuestionIndex = -1;
    userScore = 0;
    quizInProgress = false;
    stepPerformance = {};
    selectedQuizType = 'problem';
    currentQuestions = [];

    domRefs.mainTitle.innerHTML = 'ğŸ› ï¸ QCC çŸ¥è­˜é»é»å ğŸ¯';
    domRefs.welcomeScreen.classList.remove('hidden');
    domRefs.progressSection.classList.add('hidden');
    domRefs.quizContainer.classList.add('hidden');
    domRefs.resultContainer.classList.add('hidden');

    const selectProblemType = document.getElementById('selectProblemType'); 
    const selectSolutionType = document.getElementById('selectSolutionType');

    selectProblemType.onclick = () => startQuiz('problem');
    selectSolutionType.onclick = () => startQuiz('solution');

    domRefs.mainActionBtn.removeEventListener('click', handleMainAction);
    domRefs.mainActionBtn.addEventListener('click', handleMainAction);
}

// ===== é–‹å§‹æ¸¬é©— =====
function startQuiz(quizType) {
    selectedQuizType = quizType;
    currentQuestions = quizType === 'problem' ? PROBLEM_STEPS_DATA.flatMap(s => s.quiz) : SOLUTION_STEPS_DATA.flatMap(s => s.quiz);
    domRefs.mainTitle.innerHTML = quizType === 'problem' ? 'ğŸ› ï¸ QCC å•é¡Œè§£æ±ºå‹æŒ‘æˆ° ğŸ¯' : 'âœ¨ QCC èª²é¡Œé”æˆå‹æŒ‘æˆ° ğŸš€';
    domRefs.welcomeScreen.classList.add('hidden');
    domRefs.progressSection.classList.remove('hidden');
    domRefs.quizContainer.classList.remove('hidden');
    domRefs.resultContainer.classList.add('hidden');
    currentQuestionIndex = 0;
    quizInProgress = true;
    displayQuestion();
    domRefs.mainActionBtn.textContent = 'é€²è¡Œä¸‹ä¸€é¡Œ';
    domRefs.mainActionBtn.disabled = true;
}

// ===== é¡¯ç¤ºé¡Œç›® =====
function displayQuestion() {
    const q = currentQuestions[currentQuestionIndex];
    updateProgressDisplay();
    domRefs.quizQuestion.innerHTML = `<span class="text-pink-500">[${q.step}]</span> ${q.question}`;
    domRefs.quizOptions.innerHTML = '';
    q.options.forEach((opt, idx) => {
        const el = document.createElement('div');
        el.className = 'answer-option bg-white p-5 md:p-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 border-purple-200 text-lg md:text-xl font-medium text-gray-700';
        el.innerHTML = `<span class="inline-flex items-center justify-center w-8 h-8 bg-purple-100 text-purple-700 rounded-full mr-3 border-2 border-purple-400 font-extrabold text-lg">${String.fromCharCode(65+idx)}</span> ${opt}`;
        el.dataset.index = idx;
        el.addEventListener('click', () => selectAnswer(idx, el, q));
        domRefs.quizOptions.appendChild(el);
    });
    domRefs.quizFeedback.classList.add('hidden');
}

// ===== é¸æ“‡ç­”æ¡ˆ =====
function selectAnswer(idx, el, q) {
    const correct = idx === q.correctAnswerIndex;
    domRefs.quizOptions.querySelectorAll('.answer-option').forEach(opt => { opt.classList.add('disabled'); opt.style.pointerEvents='none'; });
    const stepName = q.step;
    if (!stepPerformance[stepName]) stepPerformance[stepName] = { correct:0, total:0 };
    stepPerformance[stepName].total++;
    let feedbackText='', feedbackClass='';
    if(correct){
        userScore++;
        stepPerformance[stepName].correct++;
        el.classList.add('correct-blink');
        feedbackText = `<span class="text-3xl mr-3">ğŸ‰</span>${q.feedback_correct||"ç­”å°äº†ï¼"}`;
        feedbackClass='bg-green-50 text-green-700 border-green-500 shadow-green-200';
    } else {
        el.classList.add('incorrect-shake');
        const correctEl = domRefs.quizOptions.querySelector(`[data-index="${q.correctAnswerIndex}"]`);
        if(correctEl){ correctEl.classList.add('bg-green-200','border-green-500','shadow-inner'); correctEl.classList.remove('bg-white','border-purple-200'); }
        feedbackText = `<span class="text-3xl mr-3">âŒ</span>${q.feedback_incorrect||"ç­”éŒ¯äº†ï¼"}`;
        feedbackClass='bg-red-50 text-red-700 border-red-500 shadow-red-200';
    }
    domRefs.quizFeedback.className = `mt-6 p-4 text-center rounded-xl font-bold transition-all duration-300 transform scale-100 border-2 ${feedbackClass}`;
    domRefs.quizFeedback.innerHTML = feedbackText;
    domRefs.quizFeedback.classList.remove('hidden');
    domRefs.mainActionBtn.disabled = false;
    domRefs.mainActionBtn.textContent = currentQuestionIndex < currentQuestions.length-1 ? 'ç¹¼çºŒä¸‹ä¸€é¡Œ' : 'æŸ¥çœ‹æœ€çµ‚æˆæœï¼';
}

// ===== æ›´æ–°é€²åº¦ =====
function updateProgressDisplay(){
    const total = currentQuestions.length;
    const current = currentQuestionIndex + 1;
    const percentage = (current/total)*100;
    domRefs.progressDisplay.textContent = `ç¬¬ ${current} é¡Œ / å…± ${total} é¡Œ | ç›®å‰å¾—åˆ†: ${userScore} åˆ†`;
    domRefs.progressBar.style.width = `${percentage}%`;
}

// ===== é¡¯ç¤ºçµæœ =====
function showResults(){
    quizInProgress=false;
    domRefs.quizContainer.classList.add('hidden');
    domRefs.progressSection.classList.add('hidden');
    domRefs.resultContainer.classList.remove('hidden');
    const totalQuestions=currentQuestions.length;
    const percent=Math.round((userScore/totalQuestions)*100);
    let title='', text='', cls='';
    const typeLabel=selectedQuizType==='problem'?'å•é¡Œè§£æ±ºå‹':'èª²é¡Œé”æˆå‹';
    const stepData=selectedQuizType==='problem'?PROBLEM_STEPS_DATA:SOLUTION_STEPS_DATA;
    if(percent>=90){title='ğŸ‰ å‚³å¥‡å¤§å¸«ç´šï¼'; text=`ä½ åœ¨ ${typeLabel} çš„ QCC çŸ¥è­˜å·²é”é ‚å°–æ°´å¹³ï¼`; cls='text-green-700 border-green-500 bg-green-100';}
    else if(percent>=70){title='ğŸ‘ å„ªç§€å¯¦å‹™å®¶ï¼'; text=`è¡¨ç¾éå¸¸æ£’ï¼`; cls='text-blue-700 border-blue-500 bg-blue-100';}
    else if(percent>=50){title='ğŸ§ ç©©å¥å­¸ç¿’ä¸­ï¼'; text=`ä½ å·²æŒæ¡ ${typeLabel} å¤§éƒ¨åˆ†çŸ¥è­˜`; cls='text-yellow-700 border-yellow-500 bg-yellow-100';}
    else{title='ğŸš€ æŒ‘æˆ°è€…æ¨¡å¼ï¼'; text=`é€éé€™æ¬¡ ${typeLabel} æ¸¬é©—ï¼Œä½ çŸ¥é“è©²è£œå¼·çš„æ­¥é©Ÿï¼`; cls='text-red-700 border-red-500 bg-red-100';}

    let analysisHTML=`<h3 class="text-2xl font-bold text-gray-700 mt-8 mb-4 border-b-2 border-dashed pb-2">ğŸ§  çŸ¥è­˜å¼±é»åˆ†æ (${typeLabel})</h3><ul class="space-y-3">`;
    stepData.forEach(step=>{
        const perf=stepPerformance[step.name]||{correct:0,total:0};
        const accuracy=perf.total>0?perf.correct/perf.total*100:0;
        let icon='ğŸŸ¢', textClass='text-green-600';
        if(accuracy<50){icon='ğŸ”´'; textClass='text-red-600 font-bold';} 
        else if(accuracy<100){icon='ğŸŸ¡'; textClass='text-yellow-600';}
        analysisHTML+=`<li class="flex items-center p-2 bg-gray-50 rounded-lg shadow-sm"><span class="mr-3 text-xl">${icon}</span><span class="font-semibold w-1/3">${step.id}. ${step.name}:</span><span class="${textClass}">${perf.correct} / ${perf.total} é¡Œ (${accuracy.toFixed(0)}%)</span></li>`;
    });
    analysisHTML+='</ul>';

    domRefs.resultContainer.innerHTML=`
        <h2 class="text-4xl font-extrabold text-center mb-4 ${cls}">${title}</h2>
        <p class="text-center text-xl md:text-2xl text-gray-600 mb-6">ç¸½å¾—åˆ†ï¼š${userScore} / ${totalQuestions} é¡Œ</p>
        <div class="p-4 rounded-xl ${cls} text-center font-semibold text-xl md:text-xl">${text}</div>
        ${analysisHTML}
        <button id="restartQuizBtn" class="fun-action-btn w-full mt-8 py-4 text-2xl font-bold rounded-xl shadow-lg hover:shadow-2xl">å†ä¾†ä¸€è¼ªæŒ‘æˆ°ï¼</button>
    `;
    document.getElementById('restartQuizBtn').addEventListener('click', initializeQuiz);
    domRefs.mainActionBtn.removeEventListener('click', handleMainAction);
}

// ===== ä¸‹ä¸€é¡ŒæŒ‰éˆ• =====
function handleMainAction(){
    if(currentQuestionIndex<currentQuestions.length-1){currentQuestionIndex++; displayQuestion();}
    else{showResults();}
}

// ===== é é¢è¼‰å…¥ =====
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializeQuiz);}
else{initializeQuiz();}
</script>

</body>
</html>
