<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>品管圈（QCC）新手入門指南</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設置字體為 Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .section-title {
            border-left: 6px solid #10b981; /* 翠綠色側邊裝飾 */
        }
        .ai-chat-response {
            white-space: pre-wrap; /* 保持換行和空格 */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- 主要容器 -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- 標題區塊 -->
        <header class="text-center py-10 bg-white shadow-lg rounded-xl mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">品管圈（QCC）新手入門指南</h1>
            <p class="text-xl text-gray-500">從概念到實踐，快速掌握品質改善的利器</p>
        </header>

        <!-- 內容區塊 -->
        <main class="space-y-12">

            <!-- 1. 什麼是品管圈（QCC）？ -->
            <section id="what-is-qcc" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="section-title text-2xl font-bold text-gray-800 pl-3 mb-4" data-section-title="什麼是品管圈（QCC）？">1. 什麼是品管圈？</h2>
                <div class="text-gray-600 leading-relaxed space-y-4">
                    <p>品管圈（Quality Control Circle, QCC）是一種持續改善活動，鼓勵<strong class="font-semibold text-green-600">基層同仁</strong>組成小組，共同運用各種品管工具和手法，以系統性的步驟解決工作現場的問題，或達成特定的改善目標。</p>
                    <p>它不僅是一種管理工具，更是一種<strong class="font-semibold text-green-600">品質文化</strong>的養成過程。透過這樣的活動，能培養同仁的品管意識、團隊合作能力，進而持續不斷地提升服務品質與工作效率。</p>
                </div>
                <!-- AI 輔助提問區塊 -->
                <div class="mt-8 pt-4 border-t border-gray-100">
                    <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 13a2 2 0 012-2h10a2 2 0 012 2v1a2 2 0 01-2 2H7a2 2 0 01-2-2v-1z"></path></svg>
                        AI 輔助提問：想問點關於本節內容嗎？
                    </h4>
                    <div id="chat-what-is-qcc">
                        <!-- Chat UI will be initialized here -->
                    </div>
                </div>
            </section>

            <!-- 2. 運用合適的品管工具解決問題（五大改善類型） -->
            <section id="tool-selection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="section-title text-2xl font-bold text-gray-800 pl-3 mb-4" data-section-title="運用合適的品管工具解決問題（五大改善類型）">2. 運用合適的品管工具解決問題（五大改善類型）</h2>
                <p class="text-gray-600 mb-6">品質改善活動應依據問題的性質、發生時機與目標，選擇最合適的手法和工具，以達到事半功倍的效果。</p>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 類型 1: 問題解決型 -->
                    <div class="border-t-4 border-red-500 bg-red-50 p-4 rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-red-700 mb-2">1. 問題解決型（回溯）</h3>
                        <p class="text-sm font-semibold text-red-600 mb-2">處理已發生的負面落差。</p>
                        <p class="text-sm text-gray-600">適用於**「現狀與應有狀態」之間存在負面落差**的情況。目標是解決已經發生的問題，消除不良、錯誤或低效率。</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600 text-sm pl-2">
                            <li><strong>主要手法：</strong> 品管圈 (QCC - 問題型)</li>
                            <li><strong>情境範例：</strong> 病人跌倒率、檢體退件率、文書錯誤率過高。</li>
                            <li><strong>常用工具：</strong> 舊QC七手法、特性要因圖、柏拉圖。</li>
                        </ul>
                    </div>

                    <!-- 類型 2: 課題達成型 -->
                    <div class="border-t-4 border-blue-500 bg-blue-50 p-4 rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-blue-700 mb-2">2. 課題達成型（創新型）</h3>
                        <p class="text-sm font-semibold text-blue-600 mb-2">處理現狀與理想狀態的正面差距。</p>
                        <p class="text-sm text-gray-600">適用於<strong class="font-semibold">「現狀與理想狀態」之間存在正面差距</strong>的情況。目標是達成更高層次的挑戰性目標，進行創新或突破現狀。</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600 text-sm pl-2">
                            <li><strong>主要手法：</strong> 品管圈 (QCC - 課達型)、護理專案。</li>
                            <li><strong>情境範例：</strong> 開發創新服務、提升顧客滿意度至業界標竿、導入新技術。</li>
                            <li><strong>常用工具：</strong> 新QC七手法、系統圖、親和圖。</li>
                        </ul>
                    </div>
                    
                    <!-- 類型 3: 預先防範型 -->
                    <div class="border-t-4 border-green-500 bg-green-50 p-4 rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-green-700 mb-2">3. 預先防範型（主動預防）</h3>
                        <p class="text-sm font-semibold text-green-600 mb-2">預測並消除潛在的失敗模式。</p>
                        <p class="text-sm text-gray-600">是一種<strong class="font-semibold">主動預防</strong>的風險管理工具，系統性地分析**新流程或高風險流程**中所有潛在的失敗模式、發生的影響與可能性。</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600 text-sm pl-2">
                            <li><strong>主要手法：</strong> HFMEA (Healthcare FMEA, 醫療失誤模式與效應分析)</li>
                            <li><strong>情境範例：</strong> 新藥品導入、新設備操作流程、重大手術標準化。</li>
                            <li><strong>常用工具：</strong> PDPC（預先決策計畫圖）。</li>
                        </ul>
                    </div>

                    <!-- 類型 4: 回溯型 -->
                    <div class="border-t-4 border-purple-500 bg-purple-50 p-4 rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-purple-700 mb-2">4. 回溯型（嚴重事件分析）</h3>
                        <p class="text-sm font-semibold text-purple-600 mb-2">針對已發生嚴重事件追溯原因。</p>
                        <p class="text-sm text-gray-600">針對<strong class="font-semibold">已發生或近乎發生的嚴重事件</strong>（如異常、事故）進行深入、系統性的分析，找出所有潛藏的系統性、根本性原因。</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600 text-sm pl-2">
                            <li><strong>主要手法：</strong> RCA (Root Cause Analysis, 根本原因分析)</li>
                            <li><strong>情境範例：</strong> 病人自殺事件、手術部位感染群聚、設備重大損壞。</li>
                            <li><strong>常用工具：</strong> 魚骨圖、5個Why。</li>
                        </ul>
                    </div>

                    <!-- 類型 5: 流程分析與改造 -->
                    <div class="border-t-4 border-yellow-500 bg-yellow-50 p-4 rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-yellow-700 mb-2">5. 流程優化與改造（效率）</h3>
                        <p class="text-sm font-semibold text-yellow-600 mb-2">著重於效率、成本或動線的改善。</p>
                        <p class="text-sm text-gray-600">運用IE（工業工程）思維，對現有作業流程進行診斷，找出**流程中的浪費、瓶頸和非必要環節**，並進行**根本性的重新設計**。</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600 text-sm pl-2">
                            <li><strong>主要手法：</strong> 流程分析 (Process Analysis)、流程改造 (Process Redesign)。</li>
                            <li><strong>情境範例：</strong> 門診等待時間過長、庫存盤點效率低、文件遞送動線複雜。</li>
                            <li><strong>常用工具：</strong> 流程圖、動線圖、時間研究。</li>
                        </ul>
                    </div>
                </div>
                <!-- AI 輔助提問區塊 -->
                <div class="mt-8 pt-4 border-t border-gray-100">
                    <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2m-3 10h.01M9 19v2m6-2v2M5 13a2 2 0 012-2h10a2 2 0 012 2v1a2 2 0 01-2 2H7a2 2 0 01-2-2v-1z"></path></svg>
                        AI 輔助提問：想問點關於本節內容嗎？
                    </h4>
                    <div id="chat-tool-selection">
                        <!-- Chat UI will be initialized here -->
                    </div>
                </div>
            </section>
            
            <!-- 3. 品管手法與應用步驟 (原 3. 不變) -->
            <section id="qcc-steps" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="section-title text-2xl font-bold text-gray-800 pl-3 mb-4" data-section-title="品管改善步驟（QC Story）">3. 品管改善步驟（QC Story）</h2>
                <p class="text-gray-600 mb-6">以下列舉「問題解決型」品管圈的典型十個步驟，並說明每個階段的重點工作。</p>
                
                <!-- QCC 步驟表格 -->
                <div class="overflow-x-auto rounded-lg shadow-md" id="qcc-steps-table">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">步驟</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">名稱</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-5/12">主要工作內容</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">適用工具（部分）</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm text-gray-700">
                            <tr><td class="px-3 py-4 font-medium text-green-600">1</td><td class="px-3 py-4 whitespace-nowrap">組圈與主題選定</td><td class="px-6 py-4">設定圈的組織、選定一個明確且有價值的改善主題。</td><td class="px-6 py-4">腦力激盪、親和圖、流程圖</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">2</td><td class="px-3 py-4 whitespace-nowrap">訂定活動計畫</td><td class="px-6 py-4">擬定詳細的活動時間表與分工，確保活動能按時完成。</td><td class="px-6 py-4">系統圖、箭線圖</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">3</td><td class="px-3 py-4 whitespace-nowrap">現況把握</td><td class="px-6 py-4">收集與主題相關的現狀數據，確認問題的嚴重性、範圍與真因所在。</td><td class="px-6 py-4">查檢表、層別法、柏拉圖、直方圖</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">4</td><td class="px-3 py-4 whitespace-nowrap">目標設定</td><td class="px-6 py-4">根據現況把握結果，設定具體、可行、有時限的改善目標值。</td><td class="px-6 py-4">查檢表、圖表</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">5</td><td class="px-3 py-4 whitespace-nowrap">解析</td><td class="px-6 py-4">利用科學方法，深入分析影響問題的主要原因，找出「真因」。</td><td class="px-6 py-4">特性要因圖、散佈圖、關聯圖</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">6</td><td class="px-3 py-4 whitespace-nowrap">對策擬定與實施</td><td class="px-6 py-4">針對真因，腦力激盪出有效的對策，評估後進行實施。</td><td class="px-6 py-4">系統圖、矩陣圖、PDPC</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">7</td><td class="px-3 py-4 whitespace-nowrap">效果確認</td><td class="px-6 py-4">收集實施對策後的數據，與改善前（現況把握）及目標值比較，確認改善成效。</td><td class="px-6 py-4">圖表、管制圖、柏拉圖</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">8</td><td class="px-3 py-4 whitespace-nowrap">標準化</td><td class="px-6 py-4">將有效的對策納入標準作業流程（SOP），防止問題再發。</td><td class="px-6 py-4">流程圖、文件化</td></tr>
                            <tr><td class="px-3 py-4 font-medium text-green-600">9</td><td class="px-3 py-4 whitespace-nowrap">殘留問題與未來展望</td><td class="px-6 py-4">檢討活動過程中的優缺點、分析未解決的殘留問題，並規劃下一階段的持續改善方向。</td><td class="px-6 py-4">檢討會、魚骨圖（殘留問題）</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- AI 輔助提問區塊 -->
                <div class="mt-8 pt-4 border-t border-gray-100">
                    <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        AI 輔助提問：想問點關於本節內容嗎？
                    </h4>
                    <div id="chat-qcc-steps">
                        <!-- Chat UI will be initialized here -->
                    </div>
                </div>
            </section>

            <!-- 4. 常用品管工具總覽（QC七手法） -->
            <section id="qc-tools" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="section-title text-2xl font-bold text-gray-800 pl-3 mb-4" data-section-title="常用品管工具總覽（QC七手法）">4. 常用品管工具總覽（QC七手法）</h2>
                <p class="text-gray-600 mb-6">品管工具是QCC活動中用來收集、整理、分析數據與資訊的輔助手段。以下為兩大類常用工具的詳細介紹：</p>

                <!-- 舊QC七手法表格 -->
                <h3 class="font-bold text-xl text-green-700 mb-3 border-b pb-1">舊QC七手法（QC 7 Tools）- 數據分析與統計</h3>
                <div class="overflow-x-auto rounded-lg shadow-md mb-8">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-green-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">工具名稱</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">主要功能</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">適用步驟</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm text-gray-700">
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">查檢表 (Check Sheet)</td>
                                <td class="px-6 py-4">系統性地收集數據、記錄次數。</td>
                                <td class="px-6 py-4">現況把握、效果確認（原始數據收集）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">柏拉圖 (Pareto Chart)</td>
                                <td class="px-6 py-4">將數據依發生頻率排序，找出影響最大的「重要少數」。</td>
                                <td class="px-6 py-4">現況把握（決定攻堅重點）、效果確認</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">層別法 (Stratification)</td>
                                <td class="px-6 py-4">將數據按不同屬性分類（如時間、人員、地點），釐清問題的真正發生源。</td>
                                <td class="px-6 py-4">現況把握、解析</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">特性要因圖 (Fishbone Diagram)</td>
                                <td class="px-6 py-4">將問題結果（特性）與所有可能原因（要因）進行系統性整理。</td>
                                <td class="px-6 py-4">解析（找出可能原因）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">散佈圖 (Scatter Diagram)</td>
                                <td class="px-6 py-4">分析兩組數據之間是否存在相關性（正相關、負相關或無相關）。</td>
                                <td class="px-6 py-4">解析（驗證要因間關係）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">直方圖 (Histogram)</td>
                                <td class="px-6 py-4">顯示數據的分佈形態，了解過程的穩定性與集中趨勢。</td>
                                <td class="px-6 py-4">現況把握、效果確認</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">管制圖 (Control Chart)</td>
                                <td class="px-6 py-4">監控製程是否處於統計管制狀態，用於長期品質維持。</td>
                                <td class="px-6 py-4">效果確認、標準化（效果維持監控）</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 新QC七手法表格 -->
                <h3 class="font-bold text-xl text-blue-700 mb-3 border-b pb-1">新QC七手法（New QC 7 Tools）- 語言資料整理與創新</h3>
                <div class="overflow-x-auto rounded-lg shadow-md mb-8">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">工具名稱</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">主要功能</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">適用步驟</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm text-gray-700">
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">親和圖 (Affinity Diagram)</td>
                                <td class="px-6 py-4">將大量發散的語言資料/想法，依據內在相似性分組歸納，整理複雜問題。</td>
                                <td class="px-6 py-4">主題選定、解析、對策擬定（想法收斂）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">關聯圖 (Relation Diagram)</td>
                                <td class="px-6 py-4">釐清複雜問題中，各因素之間糾結的因果關係，找到關鍵點。</td>
                                <td class="px-6 py-4">解析（複雜原因分析）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">系統圖 (Systematic Diagram)</td>
                                <td class="px-6 py-4">將目標系統性地分解為達成該目標所需要的手段、方策。</td>
                                <td class="px-6 py-4">訂定活動計畫、對策擬定</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">矩陣圖 (Matrix Diagram)</td>
                                <td class="px-6 py-4">分析兩組或多組要素之間的相互關係與強度。</td>
                                <td class="px-6 py-4">對策擬定（評估對策與真因的關係）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">箭線圖法 (Arrow Diagram)</td>
                                <td class="px-6 py-4">規劃複雜工作的時程，找出關鍵路徑，控制進度。</td>
                                <td class="px-6 py-4">訂定活動計畫（時程管理）</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium whitespace-nowrap">過程決策計畫圖 (PDPC)</td>
                                <td class="px-6 py-4">預測在計畫實施過程中可能發生的問題，並預先準備應變措施。</td>
                                <td class="px-6 py-4">對策實施（風險預防）</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <!-- AI 輔助提問區塊 -->
                <div class="mt-8 pt-4 border-t border-gray-100">
                    <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        AI 輔助提問：想問點關於本節內容嗎？
                    </h4>
                    <div id="chat-qc-tools">
                        <!-- Chat UI will be initialized here -->
                    </div>
                </div>
            </section>

        </main>

        <!-- 頁尾 -->
        <footer class="text-center py-6 mt-10 text-sm text-gray-500 border-t border-gray-200">
            <p>品質改善是一段持續的旅程。祝您的品管圈活動順利成功！</p>
        </footer>

    </div>

    <script>
        // -----------------------------------------------------
        // 1. AI Assistant Logic (Gemini API Integration)
        // -----------------------------------------------------

        // Global configuration
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const apiKey = ""; // API key is provided by the environment

        /**
         * Fetches response from the Gemini API with exponential backoff.
         * @param {Array} contents - The chat history/prompt.
         * @param {string} systemInstruction - The persona and focus for the model.
         * @param {number} maxRetries - Maximum number of retries.
         * @returns {Promise<string>} - The generated text response.
         */
        async function fetchLLMResponse(contents, systemInstruction, maxRetries = 3) {
            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            // Rate limit hit, apply exponential backoff
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '抱歉，AI 在處理時發生了錯誤。';
                    return text;

                } catch (error) {
                    console.error("LLM API Error:", error);
                    if (i === maxRetries - 1) {
                        return '抱歉，無法連接到 AI 服務。請稍後再試。';
                    }
                }
            }
        }

        /**
         * Creates and initializes the chat UI for a specific section.
         * @param {string} containerId - The ID of the container element.
         * @param {string} sectionTitle - The title of the section for context.
         */
        function initializeChat(containerId, sectionTitle) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Chat State and History (simple local storage)
            let chatHistory = [];
            let isThinking = false;

            // UI Elements Setup
            container.innerHTML = `
                <div class="chat-display bg-gray-50 p-4 rounded-lg h-48 overflow-y-auto mb-4 border border-gray-200">
                    <div class="message text-sm text-gray-500 mb-2">
                        <span class="font-bold text-indigo-600">AI 助理：</span> 您好！我是您的品質管理助理，請針對<strong class="text-indigo-700">『${sectionTitle}』</strong>提出問題。
                    </div>
                </div>
                <div class="chat-input flex space-x-2">
                    <input type="text" placeholder="輸入您的問題..." class="chat-text-input flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <button class="chat-send-button bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out font-medium text-sm disabled:opacity-50 flex items-center justify-center w-20">
                        發問
                    </button>
                </div>
            `;

            const chatDisplay = container.querySelector('.chat-display');
            const chatInput = container.querySelector('.chat-text-input');
            const sendButton = container.querySelector('.chat-send-button');

            // System Instruction is crucial for context
            const systemInstruction = `你是一位友善且知識豐富的品質管理專家。請根據『${sectionTitle}』的主題，回答使用者的提問。你的回答必須簡潔、專業且富有啟發性。`;

            // Function to add a message to the display
            const addMessage = (sender, text, isAi = false) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message text-sm p-2 rounded-lg mb-2 max-w-[90%] ${isAi ? 'bg-indigo-100 self-start' : 'bg-green-100 ml-auto text-right'}`;
                
                const senderSpan = document.createElement('span');
                senderSpan.className = `font-bold ${isAi ? 'text-indigo-600' : 'text-green-600'}`;
                senderSpan.textContent = isAi ? 'AI 助理：' : '您：';

                const textContent = document.createElement('p');
                textContent.className = 'ai-chat-response';
                textContent.innerHTML = text.replace(/\n/g, '<br>'); // Use innerHTML to respect <br>

                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(textContent);

                chatDisplay.appendChild(messageDiv);
                chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
            };

            const handleSend = async () => {
                if (isThinking) return;

                const userText = chatInput.value.trim();
                if (userText === '') return;

                // 1. Display user message
                addMessage('user', userText, false);
                chatInput.value = '';

                // 2. Set thinking state
                isThinking = true;
                sendButton.disabled = true;
                sendButton.innerHTML = `<div class="loading-spinner"></div>`;

                // 3. Prepare chat history for API
                // Keep only the last 5 user/model turns to prevent token overflow
                const historyForApi = chatHistory.slice(-10); 
                historyForApi.push({ role: "user", parts: [{ text: userText }] });

                // 4. Call AI
                const aiResponse = await fetchLLMResponse(historyForApi, systemInstruction);

                // 5. Update full chat history
                chatHistory.push({ role: "user", parts: [{ text: userText }] });
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });

                // 6. Display AI message
                addMessage('ai', aiResponse, true);

                // 7. Reset thinking state
                isThinking = false;
                sendButton.disabled = false;
                sendButton.innerHTML = `發問`;
            };

            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSend();
                }
            });
        }

        // -----------------------------------------------------
        // 2. Initialization on Load
        // -----------------------------------------------------
        window.onload = function() {
            // Find all sections with a title attribute and initialize chat for them
            const sections = document.querySelectorAll('section');

            sections.forEach(section => {
                const titleElement = section.querySelector('.section-title');
                const chatContainer = section.querySelector('[id^="chat-"]');
                
                if (titleElement && chatContainer) {
                    const sectionTitle = titleElement.getAttribute('data-section-title');
                    const containerId = chatContainer.id;
                    initializeChat(containerId, sectionTitle);
                }
            });
        };
    </script>
</body>
</html>
